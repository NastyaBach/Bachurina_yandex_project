# Работа Бачуриной Анастасии #
# Второе вступительное задание от Школы бэкенд-разработки # 

В данном файле представлен разбор моего решения. 
Была поставлена задача: разработать REST API сервис, который позволяет пользователям загружать и обновлять информацию о файлах и папках.

Я реализовала сервис на Python, используя следующие инструменты:
- FastAPI - асинхронный веб-фреймворк для создания API
- Uvicorn - ASGI-сервер с акцентом на скорость
- Pydantic - библиотека для валидации данных
- PostgreSQL - объектно-реляционная система управления базами данных
- SQLAlchemy - библиотека для работы с базой данных с применением технологии ORM (для синхронизации объектов и записей реляционной базы данных)
- Docker - программа для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации

# База данных #

В первой таблице, "system_items", хранится основная информация об объектах. Она используется при импорте, просмотре и удалении объектов.
Таблица "system_items" состоит из след. колонок:

- id - уникальный id каждого элемента, задаётся в формате String, не может быть пустым
- type - тип объекта: папка или файл. С помощью Enum задаю на вход только два возможных значения: FOLDER или FILE
- url - ссылка объектов, может быть по умолчанию None, задаётся только в формате String
- parentId - если объект находится внутри папки, сюда записывается id этой папки. None, если объект находится в корне.
- size - размер файла и папок, в которых есть файлы. Задаётся в формате Integer, по умолчанию 0, если папка, у файлов всегда больше нуля
- date - дата обрабатывается согласно ISO 8601
- children - с помощью функции relationship() (из sqlalchemy.orm) возвращается список файлов и папок, которые находятся внутри рассматриваемой папки 
  (имеют ссылки в parentId на текущий id)


Вторая таблица, 'history', нужна для отслеживания истории изменений каждого объекта. 
Таблица 'history' состоит из след. колонок:
- id - автоматически инкрементируемый столбец, уникальный id в формате Integer
- item_id - id, под которым элемент находится в первой таблице
- date - дата обновления, обрабатывается согласно ISO 8601


В файле db.py:
- создаётся движок с помощью функции create_engine(), 
- указывается адрес (SQL_URL) базы данных,
- задаётся декларативная схема описания данных с помощью declarative_base
- задаются сессии sessionmaker()
- описываем функцию get_db(), которая открывает базу данных, проводит операции при необходимости и в конце закрывает её


В файле models.py описываются схемы таблиц базы данных, а также какой тип данных ожидается в каждой колонке.
Также прописывается, могут ли быть значения по умолчанию и чем они равны.


# Импорт, вывод, обновление и удаление данных #

В файле schemas.py данные инициализируется. Ожидается, что программа получит именно такой тип данных. В противном случае будет вызываться ошибка 400 - Bad Request


В файле helpers.py описано четыре функции, которые помогают основным операциям:

- функция calculate_size() изменяет размер папок при добавлении или удалении папок. 
  Вызывая рекурсию, идёт из внутреннего обекта к самому верхнему, меняя у всех размер папок размер
- функция update_date() рекурсией обновляет дату изменения всех папок, а также добавляет историю изменения в таблицу 'history'
- функция deleter() удаляет все дочерние элементы и их истории изменений в таблице 'history'
- функция output() - для вывода списка детей (внутренних элементов) объекта


В файле main.py:

- в функции validation_exception_handler переопределяем статус ошибки для pydantic validator, который проверяет входные данные

- в функции import_items анализируем передаваемый объект.
   - если id равен parentId или parentId ранее не был встречен, выводится ошибка
   - если объект уже есть, обновляется размер, дата и история изменения объекта и всех внешних файлов
   - если объект не найден, создаётся новый
   - изменяется размер папок, обновляется дата изменения и дополняется история изменений


- функция delete_item:
  - по переданному id в базе данных находится объект. Далее объект удаляется, дата изменений обновляется, а размер внешних папок уменьшается
  - если объект не найден - ошибка 404


- функция get_item:
  - по переданному id в базе данных находится объект. Если находится - возращаем
  - если объект не найден - ошибка 404


- функция get_updates:
  - выбираем все существующие объекты
  - фильтруем, чтобы среди них остались только те, которые были изменены последние 2 часа
  - возвращаем все подошедшие объекты


- функция get_history:
  - по переданному id в базе данных находится объект
  - выбираем данные изменения объекта, фильтруем, чтобы время входило в заданный промежуток времени
  - если объект не найден - ошибка 404


# Неправильно выполненное условие #

Для функции get_node не смогла описать response модель, т.к. внутри класса определялся список элементов того же класса, Python не позволяет это.

Я не успела придумать другой способ, который не был бы затратным с точки зрения ресурсов и времени, но работал бы полностью правильно

# Спасибо за внимание #